<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>S1M Requirements Admin Console</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .header {
            background-color: #007bff;
            color: white;
            padding: 20px;
            margin: -20px -20px 20px -20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .header h1 {
            margin: 0;
        }
        .nav-link {
            color: white;
            text-decoration: none;
            padding: 10px 20px;
            background-color: rgba(255,255,255,0.2);
            border-radius: 5px;
            transition: background-color 0.3s;
        }
        .nav-link:hover {
            background-color: rgba(255,255,255,0.3);
        }
        .container {
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        .table-container {
            overflow-x: auto;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        th {
            background-color: #f8f9fa;
            font-weight: bold;
            color: #495057;
        }
        tr:hover {
            background-color: #f8f9fa;
            cursor: pointer;
        }
        .status {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
            text-transform: uppercase;
        }
        .status.new {
            background-color: #d4edda;
            color: #155724;
        }
        .status.reviewed {
            background-color: #cce5ff;
            color: #004085;
        }
        .status.approved {
            background-color: #d1ecf1;
            color: #0c5460;
        }
        .no-submissions {
            text-align: center;
            padding: 40px;
            color: #6c757d;
        }
        .no-submissions h3 {
            margin-bottom: 10px;
        }
        
        /* Lightbox Styles */
        .lightbox {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        .lightbox-content {
            position: relative;
            background-color: white;
            margin: 2% auto;
            padding: 0;
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }
        .lightbox-header {
            background-color: #007bff;
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .lightbox-header h2 {
            margin: 0;
        }
        .close-btn {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .close-btn:hover {
            background-color: rgba(255,255,255,0.2);
            border-radius: 50%;
        }
        .lightbox-body {
            padding: 20px;
            max-height: 60vh;
            overflow-y: auto;
        }
        .lightbox-footer {
            padding: 20px;
            border-top: 1px solid #ddd;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.3s;
        }
        .btn-primary {
            background-color: #007bff;
            color: white;
        }
        .btn-primary:hover {
            background-color: #0056b3;
        }
        .btn-secondary {
            background-color: #6c757d;
            color: white;
        }
        .btn-secondary:hover {
            background-color: #545b62;
        }
        .form-section {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .form-section h3 {
            margin-top: 0;
            color: #007bff;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        .form-group textarea {
            height: 80px;
            resize: vertical;
        }
        .manuscript-types, .additional-questions {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .manuscript-types input, .additional-questions input {
            width: 100%;
        }
        .questions-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        .questions-table th {
            background-color: #f8f9fa;
            padding: 12px;
            text-align: left;
            border: 1px solid #ddd;
            font-weight: bold;
        }
        .questions-table th:last-child {
            text-align: center;
            width: 100px;
        }
        .questions-table td {
            padding: 12px;
            border: 1px solid #ddd;
            vertical-align: top;
        }
        .questions-table td:last-child {
            text-align: center;
            vertical-align: middle;
        }
        .questions-table tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        .questions-table input[type="checkbox"] {
            width: auto;
            transform: scale(1.2);
        }
        .unsaved-changes {
            color: #dc3545;
            font-style: italic;
            margin-left: 10px;
        }
        .status {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
            text-transform: uppercase;
        }
        .status.new {
            background-color: #e3f2fd;
            color: #1976d2;
        }
        .status.reviewed {
            background-color: #fff3e0;
            color: #f57c00;
        }
        .status.in_progress {
            background-color: #f3e5f5;
            color: #7b1fa2;
        }
        .status.completed {
            background-color: #e8f5e8;
            color: #388e3c;
        }
        .action-btn {
            padding: 4px 8px;
            margin: 0 2px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
        }
        .action-btn.edit {
            background-color: #007bff;
            color: white;
        }
        .action-btn.status {
            background-color: #28a745;
            color: white;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>S1M Requirements Admin Console</h1>
        <div>
            <button onclick="openNewRequestLightbox()" style="margin-right: 15px; padding: 8px 16px; background: #28a745; border: none; color: white; border-radius: 5px; cursor: pointer; font-weight: bold;">+ New Requirement Request</button>
            <button onclick="refreshData()" style="margin-right: 10px; padding: 5px 10px; background: rgba(255,255,255,0.2); border: none; color: white; border-radius: 3px; cursor: pointer;">Refresh</button>
            <button onclick="debugLocalStorage()" style="margin-right: 10px; padding: 5px 10px; background: rgba(255,255,255,0.2); border: none; color: white; border-radius: 3px; cursor: pointer;">Debug</button>
            <button onclick="clearLocalStorage()" style="margin-right: 10px; padding: 5px 10px; background: rgba(255,255,255,0.2); border: none; color: white; border-radius: 3px; cursor: pointer;">Clear Data</button>
            <a href="index.html" class="nav-link">‚Üê Back to Form</a>
        </div>
    </div>

    <div class="container">
        <!-- Search and Filter Controls -->
        <div style="background-color: #f8f9fa; padding: 20px; border-radius: 5px; margin-bottom: 20px;">
            <div style="display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
                <div style="flex: 1; min-width: 200px;">
                    <label for="searchInput" style="display: block; margin-bottom: 5px; font-weight: bold;">Search:</label>
                    <input type="text" id="searchInput" placeholder="Search by journal name, customer, or URL..." style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;" oninput="filterSubmissions()">
                </div>
                <div>
                    <label for="statusFilter" style="display: block; margin-bottom: 5px; font-weight: bold;">Status:</label>
                    <select id="statusFilter" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px;" onchange="filterSubmissions()">
                        <option value="">All Statuses</option>
                        <option value="new">New</option>
                        <option value="reviewed">Reviewed</option>
                        <option value="in_progress">In Progress</option>
                        <option value="completed">Completed</option>
                    </select>
                </div>
                <div>
                    <label for="workflowFilter" style="display: block; margin-bottom: 5px; font-weight: bold;">Workflow:</label>
                    <select id="workflowFilter" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px;" onchange="filterSubmissions()">
                        <option value="">All Workflows</option>
                        <option value="option1">One Level Editor</option>
                        <option value="option2">Two Levels (First Decides)</option>
                        <option value="option3">Two Levels (Second Decides)</option>
                    </select>
                </div>
                <div>
                    <label for="dateFilter" style="display: block; margin-bottom: 5px; font-weight: bold;">Date Range:</label>
                    <select id="dateFilter" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px;" onchange="filterSubmissions()">
                        <option value="">All Time</option>
                        <option value="today">Today</option>
                        <option value="week">This Week</option>
                        <option value="month">This Month</option>
                    </select>
                </div>
                <div style="margin-top: 20px;">
                    <button onclick="clearFilters()" style="padding: 8px 15px; background-color: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer;">Clear Filters</button>
                    <span id="filterResults" style="margin-left: 15px; color: #666; font-size: 14px;"></span>
                </div>
            </div>
        </div>

        <div class="table-container">
            <table id="submissionsTable">
                <thead>
                    <tr>
                        <th>Submitted</th>
                        <th>Journal Name</th>
                        <th>Customer</th>
                        <th>Workflow</th>
                        <th>Review Process</th>
                        <th>URL Suffix</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="submissionsTableBody">
                    <!-- Submissions will be populated here -->
                </tbody>
            </table>
        </div>
        
        <div class="no-submissions" id="noSubmissions">
            <h3>No Submissions Found</h3>
            <p>No customer requirements have been submitted yet.</p>
            <p><a href="index.html">Go to the form</a> to create your first submission.</p>
        </div>
    </div>

    <!-- Lightbox for editing submissions -->
    <div id="editLightbox" class="lightbox">
        <div class="lightbox-content">
            <div class="lightbox-header">
                <h2>Edit Submission <span class="unsaved-changes" id="unsavedIndicator" style="display: none;">‚Ä¢ Unsaved Changes</span></h2>
                <button class="close-btn" onclick="closeLightbox()">&times;</button>
            </div>
            <div class="lightbox-body">
                <form id="editForm">
                    <div class="form-section">
                        <h3>Journal Information</h3>
                        <div class="form-group">
                            <label for="editJournalName">Journal Name:</label>
                            <input type="text" id="editJournalName" name="journalName">
                        </div>
                        <div class="form-group">
                            <label for="editUrlSuffix">URL Suffix:</label>
                            <input type="text" id="editUrlSuffix" name="urlSuffix" maxlength="18">
                        </div>
                    </div>

                    <div class="form-section">
                        <h3>Editorial Process</h3>
                        <div class="form-group">
                            <label for="editWorkflow">Workflow:</label>
                            <select id="editWorkflow" name="workflow">
                                <option value="option1">Option 1 ‚Äì One Level of Editor</option>
                                <option value="option2">Option 2 ‚Äì Two Levels of Editor, First Editor Makes Final Decision</option>
                                <option value="option3">Option 3 ‚Äì Two Levels of Editor, Second Editor Makes Final Decision</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="editPeerReview">Peer Review Process:</label>
                            <select id="editPeerReview" name="peerReview">
                                <option value="single">Single</option>
                                <option value="double">Double</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="editDefaultRole">Default Role:</label>
                            <select id="editDefaultRole" name="defaultRole">
                                <option value="author">Author</option>
                                <option value="author-reviewer">Author and Reviewer</option>
                                <option value="reviewer">Reviewer</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-section">
                        <h3>Manuscript Types</h3>
                        <div class="manuscript-types" id="editManuscriptTypes">
                            <!-- Manuscript types will be populated here -->
                        </div>
                    </div>

                    <div class="form-section">
                        <h3>Standard Questions</h3>
                        <div id="editStandardQuestions">
                            <!-- Standard questions will be populated here -->
                        </div>
                    </div>

                    <div class="form-section">
                        <h3>Additional Questions</h3>
                        <div class="additional-questions" id="editAdditionalQuestions">
                            <!-- Additional questions will be populated here -->
                        </div>
                    </div>

                    <div class="form-section">
                        <h3>Additional Information</h3>
                        <div class="form-group">
                            <label for="editAdditionalInfo">Additional Information:</label>
                            <textarea id="editAdditionalInfo" name="additionalInfo"></textarea>
                        </div>
                    </div>
                </form>
            </div>
            <div class="lightbox-footer">
                <button class="btn btn-secondary" onclick="closeLightbox()">Close</button>
                <button class="btn btn-primary" onclick="saveSubmission()">Save Changes</button>
            </div>
        </div>
    </div>

    <!-- Salesforce Account Search Lightbox -->
    <div id="newRequestLightbox" class="lightbox">
        <div class="lightbox-content">
            <div class="lightbox-header">
                <h2>New Requirement Request - Select Customer</h2>
                <button class="close-btn" onclick="closeNewRequestLightbox()">&times;</button>
            </div>
            <div class="lightbox-body">
                <!-- Status Section -->
                <div id="statusSection">
                    <div style="background-color: #e8f4fd; border: 1px solid #007bff; padding: 15px; border-radius: 5px; margin-bottom: 20px;">
                        <div id="authResult">Initializing...</div>
                    </div>
                </div>

                <!-- Authentication Section (hidden by default) -->
                <div id="authSection" style="display: none;">
                    <div style="background-color: #fff3cd; border: 1px solid #ffeaa7; padding: 15px; border-radius: 5px; margin-bottom: 20px;">
                        <h3>Salesforce Authentication Required</h3>
                        <p>Please authenticate with Salesforce to search for customers.</p>
                        <div class="form-group">
                            <label for="salesforceUrl">Your Salesforce URL:</label>
                            <input type="url" id="salesforceUrl" placeholder="https://scholarone.my.salesforce.com" value="https://scholarone.my.salesforce.com">
                        </div>
                        <button onclick="authenticateSalesforce()" style="background-color: #007bff; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer;">Connect to Salesforce</button>
                    </div>
                </div>

                <!-- Search Section -->
                <div id="searchSection" style="display: none;">
                    <div style="background-color: #d4edda; border: 1px solid #28a745; padding: 15px; border-radius: 5px; margin-bottom: 20px;">
                        <h3>Search Customers</h3>
                        <div class="form-group">
                            <label for="customerSearch">Search for a customer:</label>
                            <input type="text" id="customerSearch" placeholder="Enter company name or partial name">
                        </div>
                        <button onclick="searchCustomers()" style="background-color: #28a745; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer;">Search Salesforce</button>
                        <div id="searchResults" style="margin-top: 20px;"></div>
                    </div>
                </div>

                <!-- Selected Customer -->
                <div id="selectedCustomerSection" style="display: none;">
                    <div style="background-color: #e8f5e8; border: 1px solid #28a745; padding: 15px; border-radius: 5px;">
                        <h3>Selected Customer</h3>
                        <div id="selectedCustomerDetails"></div>
                    </div>
                </div>
            </div>
            <div class="lightbox-footer">
                <button class="btn btn-secondary" onclick="closeNewRequestLightbox()">Cancel</button>
                <button class="btn btn-primary" id="proceedBtn" onclick="proceedToForm()" style="display: none;">Proceed to Form</button>
            </div>
        </div>
    </div>

    <script>
        // Sample data for demonstration
        let submissions = [];
        let currentEditingSubmission = null;
        let hasUnsavedChanges = false;

        // Initialize the admin console
        function init() {
            loadSubmissions();
            renderSubmissions();
            setupFormChangeDetection();
        }

        // Load submissions from localStorage
        function loadSubmissions() {
            const saved = localStorage.getItem('s1m_submissions');
            console.log('Loading submissions from localStorage:', saved);
            if (saved) {
                try {
                    submissions = JSON.parse(saved);
                    console.log('Parsed submissions:', submissions);
                } catch (e) {
                    console.error('Error parsing submissions:', e);
                    submissions = [];
                }
            } else {
                console.log('No submissions found in localStorage');
                submissions = [];
            }
        }

        // Save submissions to localStorage
        function saveSubmissions() {
            localStorage.setItem('s1m_submissions', JSON.stringify(submissions));
        }

        // Store filtered submissions
        let filteredSubmissions = [];

        // Render submissions table
        function renderSubmissions(submissionsToRender = null) {
            const tbody = document.getElementById('submissionsTableBody');
            const noSubmissions = document.getElementById('noSubmissions');
            
            // Use provided submissions or all submissions
            const currentSubmissions = submissionsToRender || submissions;
            filteredSubmissions = currentSubmissions;
            
            if (currentSubmissions.length === 0) {
                tbody.innerHTML = '';
                noSubmissions.style.display = 'block';
                updateFilterResults(0, submissions.length);
                return;
            }

            noSubmissions.style.display = 'none';
            
            tbody.innerHTML = currentSubmissions.map((submission, index) => {
                // Get original index in full submissions array
                const originalIndex = submissions.findIndex(s => s.submittedAt === submission.submittedAt && s.journalName === submission.journalName);
                
                const workflowText = getWorkflowText(submission.workflow);
                const reviewText = submission.peerReview === 'single' ? 'Single' : 'Double';
                const submittedDate = new Date(submission.submittedAt || Date.now()).toLocaleDateString('en-US');
                const customerName = submission.customerData ? submission.customerData.name : 'N/A';
                const status = getSubmissionStatus(submission);
                
                return `
                    <tr>
                        <td>${submittedDate}</td>
                        <td>${submission.journalName || 'Untitled Journal'}</td>
                        <td>${customerName}</td>
                        <td>${workflowText}</td>
                        <td>${reviewText}</td>
                        <td>${submission.urlSuffix || 'N/A'}</td>
                        <td><span class="status ${status.class}">${status.text}</span></td>
                        <td>
                            <button class="action-btn edit" onclick="openEditLightbox(${originalIndex})">Edit</button>
                            <button class="action-btn status" onclick="cycleStatus(${originalIndex})">Status</button>
                        </td>
                    </tr>
                `;
            }).join('');
            
            updateFilterResults(currentSubmissions.length, submissions.length);
        }

        // Get submission status based on various factors
        function getSubmissionStatus(submission) {
            // Initialize status if not set
            if (!submission.status) {
                submission.status = 'new';
            }
            
            // Auto-update status based on time and interaction
            const submittedDate = new Date(submission.submittedAt || Date.now());
            const daysSinceSubmission = (Date.now() - submittedDate.getTime()) / (1000 * 60 * 60 * 24);
            
            // If it's been edited, it's at least "reviewed"
            if (submission.lastModified && submission.status === 'new') {
                submission.status = 'reviewed';
            }
            
            // Auto-change very old "new" submissions to "reviewed"
            if (submission.status === 'new' && daysSinceSubmission > 7) {
                submission.status = 'reviewed';
            }
            
            const statusMap = {
                'new': { text: 'New', class: 'new' },
                'reviewed': { text: 'Reviewed', class: 'reviewed' },
                'in_progress': { text: 'In Progress', class: 'in_progress' },
                'completed': { text: 'Completed', class: 'completed' }
            };
            
            return statusMap[submission.status] || statusMap['new'];
        }

        // Cycle through status options
        function cycleStatus(index) {
            const statusOrder = ['new', 'reviewed', 'in_progress', 'completed'];
            const submission = submissions[index];
            const currentStatusIndex = statusOrder.indexOf(submission.status || 'new');
            const nextStatusIndex = (currentStatusIndex + 1) % statusOrder.length;
            
            submission.status = statusOrder[nextStatusIndex];
            submission.lastModified = new Date().toISOString();
            
            saveSubmissions();
            filterSubmissions(); // Re-render with current filters
        }

        // Get readable workflow text
        function getWorkflowText(workflow) {
            switch(workflow) {
                case 'option1': return 'One Level of Editor';
                case 'option2': return 'Two Levels (First Decides)';
                case 'option3': return 'Two Levels (Second Decides)';
                default: return 'Unknown';
            }
        }

        // Filter submissions based on search and filter criteria
        function filterSubmissions() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const statusFilter = document.getElementById('statusFilter').value;
            const workflowFilter = document.getElementById('workflowFilter').value;
            const dateFilter = document.getElementById('dateFilter').value;

            let filtered = submissions.filter(submission => {
                // Search filter
                const searchMatch = !searchTerm || 
                    (submission.journalName || '').toLowerCase().includes(searchTerm) ||
                    (submission.urlSuffix || '').toLowerCase().includes(searchTerm) ||
                    (submission.customerData && submission.customerData.name || '').toLowerCase().includes(searchTerm);

                // Status filter
                const status = getSubmissionStatus(submission);
                const statusMatch = !statusFilter || status.class === statusFilter;

                // Workflow filter
                const workflowMatch = !workflowFilter || submission.workflow === workflowFilter;

                // Date filter
                const dateMatch = matchesDateFilter(submission, dateFilter);

                return searchMatch && statusMatch && workflowMatch && dateMatch;
            });

            renderSubmissions(filtered);
        }

        // Check if submission matches date filter
        function matchesDateFilter(submission, dateFilter) {
            if (!dateFilter) return true;

            const submittedDate = new Date(submission.submittedAt || Date.now());
            const now = new Date();
            
            switch(dateFilter) {
                case 'today':
                    return submittedDate.toDateString() === now.toDateString();
                case 'week':
                    const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                    return submittedDate >= weekAgo;
                case 'month':
                    const monthAgo = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
                    return submittedDate >= monthAgo;
                default:
                    return true;
            }
        }

        // Clear all filters
        function clearFilters() {
            document.getElementById('searchInput').value = '';
            document.getElementById('statusFilter').value = '';
            document.getElementById('workflowFilter').value = '';
            document.getElementById('dateFilter').value = '';
            filterSubmissions();
        }

        // Update filter results display
        function updateFilterResults(showing, total) {
            const filterResults = document.getElementById('filterResults');
            if (showing === total) {
                filterResults.textContent = `Showing all ${total} submissions`;
            } else {
                filterResults.textContent = `Showing ${showing} of ${total} submissions`;
            }
        }

        // Open edit lightbox
        function openEditLightbox(index) {
            currentEditingSubmission = index;
            const submission = submissions[index];
            
            // Populate form fields
            document.getElementById('editJournalName').value = submission.journalName || '';
            document.getElementById('editUrlSuffix').value = submission.urlSuffix || '';
            document.getElementById('editWorkflow').value = submission.workflow || 'option1';
            document.getElementById('editPeerReview').value = submission.peerReview || 'single';
            document.getElementById('editDefaultRole').value = submission.defaultRole || 'author';
            document.getElementById('editAdditionalInfo').value = submission.additionalInfo || '';
            
            // Populate manuscript types
            populateManuscriptTypes(submission.manuscriptTypes || []);
            
            // Populate standard questions
            populateStandardQuestions(submission);
            
            // Populate additional questions
            populateAdditionalQuestions(submission.additionalQuestions || []);
            
            // Show lightbox
            document.getElementById('editLightbox').style.display = 'block';
            resetUnsavedChanges();
        }

        // Close lightbox
        function closeLightbox() {
            if (hasUnsavedChanges) {
                if (!confirm('You have unsaved changes. Are you sure you want to close without saving?')) {
                    return;
                }
            }
            
            document.getElementById('editLightbox').style.display = 'none';
            currentEditingSubmission = null;
            resetUnsavedChanges();
        }

        // Populate manuscript types
        function populateManuscriptTypes(types) {
            const container = document.getElementById('editManuscriptTypes');
            container.innerHTML = types.map((type, index) => 
                `<input type="text" value="${type}" data-index="${index}" class="manuscript-type-input">`
            ).join('');
        }

        // Populate standard questions
        function populateStandardQuestions(submission) {
            const container = document.getElementById('editStandardQuestions');
            const questions = [
                { key: 'numFigures', label: 'Number of Figures' },
                { key: 'numTables', label: 'Number of Tables' },
                { key: 'numColorFigures', label: 'Number of Color Figures' },
                { key: 'numWords', label: 'Number of Words' },
                { key: 'prevSubmission', label: 'Has this manuscript been submitted previously to this journal' },
                { key: 'journalCovers', label: 'Are any of the included images potential journal covers' },
                { key: 'colorFee', label: 'Are you willing to pay the journal\'s fee for color reproduction?' },
                { key: 'soleSubmission', label: 'Confirm that the manuscript has been submitted solely to this journal and is not published, in press, or submitted elsewhere.' },
                { key: 'ethicalGuidelines', label: 'Confirm that all the research meets the ethical guidelines, including adherence to the legal requirements of the study country.' },
                { key: 'conflictInterest', label: 'Do you have any conflict of interest?' },
                { key: 'anonymizedReview', label: 'Confirm that you have prepared a complete text minus the title page, acknowledgments, and any running headers with author names, to allow anonymized review.' },
                { key: 'researchFunding', label: 'Do you wish to include the ability to collect research funding information for manuscripts?' }
            ];

            container.innerHTML = `
                <table class="questions-table">
                    <thead>
                        <tr>
                            <th>Question</th>
                            <th>Include?</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${questions.map(q => `
                            <tr>
                                <td>${q.label}</td>
                                <td><input type="checkbox" name="${q.key}" value="yes" ${submission[q.key] === 'yes' ? 'checked' : ''}></td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        // Populate additional questions
        function populateAdditionalQuestions(questions) {
            const container = document.getElementById('editAdditionalQuestions');
            container.innerHTML = questions.map((question, index) => 
                `<input type="text" value="${question}" data-index="${index}" class="additional-question-input">`
            ).join('');
        }

        // Save submission
        function saveSubmission() {
            if (currentEditingSubmission === null) return;
            
            const formData = new FormData(document.getElementById('editForm'));
            const submission = submissions[currentEditingSubmission];
            
            // Update basic fields
            submission.journalName = formData.get('journalName');
            submission.urlSuffix = formData.get('urlSuffix');
            submission.workflow = formData.get('workflow');
            submission.peerReview = formData.get('peerReview');
            submission.defaultRole = formData.get('defaultRole');
            submission.additionalInfo = formData.get('additionalInfo');
            
            // Update manuscript types
            const manuscriptInputs = document.querySelectorAll('.manuscript-type-input');
            submission.manuscriptTypes = Array.from(manuscriptInputs)
                .map(input => input.value.trim())
                .filter(value => value);
            
            // Update standard questions (handle checkboxes)
            const standardQuestions = [
                'numFigures', 'numTables', 'numColorFigures', 'numWords',
                'prevSubmission', 'journalCovers', 'colorFee', 'soleSubmission',
                'ethicalGuidelines', 'conflictInterest', 'anonymizedReview', 'researchFunding'
            ];
            
            standardQuestions.forEach(key => {
                submission[key] = formData.get(key) ? 'yes' : 'no';
            });
            
            // Update additional questions
            const additionalInputs = document.querySelectorAll('.additional-question-input');
            submission.additionalQuestions = Array.from(additionalInputs)
                .map(input => input.value.trim())
                .filter(value => value);
            
            // Mark as reviewed and update timestamp
            if (submission.status === 'new') {
                submission.status = 'reviewed';
            }
            submission.lastModified = new Date().toISOString();
            
            // Save to localStorage
            saveSubmissions();
            
            // Update table display with current filters
            filterSubmissions();
            
            // Close lightbox
            closeLightbox();
            
            alert('Submission updated successfully!');
        }

        // Setup form change detection
        function setupFormChangeDetection() {
            document.addEventListener('input', function(e) {
                if (e.target.closest('#editForm')) {
                    markUnsavedChanges();
                }
            });
        }

        // Mark unsaved changes
        function markUnsavedChanges() {
            hasUnsavedChanges = true;
            document.getElementById('unsavedIndicator').style.display = 'inline';
        }

        // Reset unsaved changes
        function resetUnsavedChanges() {
            hasUnsavedChanges = false;
            document.getElementById('unsavedIndicator').style.display = 'none';
        }

        // Handle clicks outside lightbox
        window.onclick = function(event) {
            const lightbox = document.getElementById('editLightbox');
            if (event.target === lightbox) {
                closeLightbox();
            }
        }

        // Debug functions
        function debugLocalStorage() {
            console.log('=== LocalStorage Debug ===');
            const saved = localStorage.getItem('s1m_submissions');
            console.log('Raw localStorage data:', saved);
            
            if (saved) {
                try {
                    const parsed = JSON.parse(saved);
                    console.log('Parsed data:', parsed);
                    console.log('Number of submissions:', parsed.length);
                    parsed.forEach((submission, index) => {
                        console.log(`Submission ${index}:`, submission);
                    });
                } catch (e) {
                    console.error('Error parsing data:', e);
                }
            } else {
                console.log('No data found in localStorage');
            }
            
            console.log('Current submissions array:', submissions);
            alert('Debug info logged to console. Check browser developer tools.');
        }
        
        function clearLocalStorage() {
            if (confirm('Are you sure you want to clear all submissions?')) {
                localStorage.removeItem('s1m_submissions');
                submissions = [];
                renderSubmissions();
                alert('All submissions cleared!');
            }
        }
        
        function refreshData() {
            loadSubmissions();
            renderSubmissions();
        }

        // ===== NEW REQUEST WORKFLOW FUNCTIONS =====
        
        let sessionToken = null;
        let selectedCustomer = null;
        const backendUrl = 'https://s1m-customer-requirements-form.onrender.com';

        // Open new request lightbox
        function openNewRequestLightbox() {
            document.getElementById('newRequestLightbox').style.display = 'block';
            
            // Check if already authenticated from URL params
            const urlParams = new URLSearchParams(window.location.search);
            const success = urlParams.get('success');
            const session = urlParams.get('session');
            
            if (success === 'true' && session) {
                sessionToken = session;
                // Store session for future use
                localStorage.setItem('salesforce_session_token', session);
                showMessage('authResult', 'Successfully connected to Salesforce!', 'success');
                showSearchSection();
                window.history.replaceState({}, document.title, window.location.pathname);
                return;
            }
            
            // Check if we have a stored session token
            const storedSession = localStorage.getItem('salesforce_session_token');
            if (storedSession) {
                sessionToken = storedSession;
                showSearchSection();
                return;
            }
            
            // Auto-attempt Salesforce authentication
            showMessage('authResult', 'Connecting to Salesforce...', 'loading');
            autoAuthenticate();
        }

        // Show search section and hide auth
        function showSearchSection() {
            document.getElementById('statusSection').style.display = 'none';
            document.getElementById('authSection').style.display = 'none';
            document.getElementById('searchSection').style.display = 'block';
        }

        // Auto-authenticate with Salesforce using stored/default URL
        async function autoAuthenticate() {
            const salesforceUrl = 'https://scholarone.my.salesforce.com'; // Default to your org
            
            try {
                const response = await fetch(`${backendUrl}/api/auth/start`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ 
                        salesforceUrl,
                        redirectPage: 'auth-callback.html'  // Use a dedicated callback page
                    })
                });

                if (!response.ok) {
                    throw new Error(`Backend error: ${response.status}`);
                }

                const data = await response.json();
                
                // Open Salesforce auth in a popup window
                const popup = window.open(
                    data.authUrl,
                    'salesforce-auth',
                    'width=600,height=700,scrollbars=yes,resizable=yes'
                );
                
                // Listen for popup completion
                const checkClosed = setInterval(() => {
                    if (popup.closed) {
                        clearInterval(checkClosed);
                        // Check if we got a session token
                        checkAuthResult();
                    }
                }, 1000);
                
            } catch (error) {
                console.error('Auto-authentication error:', error);
                // Fall back to manual authentication UI
                showMessage('authResult', 'Please authenticate with Salesforce manually', 'error');
                document.getElementById('authSection').style.display = 'block';
            }
        }

        // Check auth result after popup closes
        function checkAuthResult() {
            const storedSession = localStorage.getItem('salesforce_session_token_temp');
            if (storedSession) {
                sessionToken = storedSession;
                localStorage.setItem('salesforce_session_token', storedSession);
                localStorage.removeItem('salesforce_session_token_temp');
                showSearchSection();
            } else {
                showMessage('authResult', 'Authentication was cancelled or failed', 'error');
                document.getElementById('authSection').style.display = 'block';
            }
        }

        // Close new request lightbox
        function closeNewRequestLightbox() {
            document.getElementById('newRequestLightbox').style.display = 'none';
            // Reset form state
            document.getElementById('searchSection').style.display = 'none';
            document.getElementById('selectedCustomerSection').style.display = 'none';
            document.getElementById('proceedBtn').style.display = 'none';
            sessionToken = null;
            selectedCustomer = null;
        }

        // Authenticate with Salesforce
        async function authenticateSalesforce() {
            const salesforceUrl = document.getElementById('salesforceUrl').value;
            
            if (!salesforceUrl) {
                showMessage('authResult', 'Please enter your Salesforce URL', 'error');
                return;
            }

            try {
                showMessage('authResult', 'Starting authentication...', 'loading');

                const response = await fetch(`${backendUrl}/api/auth/start`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ 
                        salesforceUrl,
                        redirectPage: 'admin.html'
                    })
                });

                if (!response.ok) {
                    throw new Error(`Backend error: ${response.status}`);
                }

                const data = await response.json();
                
                // Redirect to Salesforce
                window.location.href = data.authUrl;
                
            } catch (error) {
                console.error('Authentication error:', error);
                showMessage('authResult', `Authentication failed: ${error.message}`, 'error');
            }
        }

        // Search customers
        async function searchCustomers() {
            const searchTerm = document.getElementById('customerSearch').value;
            
            if (!searchTerm) {
                showMessage('searchResults', 'Please enter a search term', 'error');
                return;
            }

            if (!sessionToken) {
                showMessage('searchResults', 'Please authenticate with Salesforce first', 'error');
                handleSessionExpired();
                return;
            }

            try {
                showMessage('searchResults', 'Searching Salesforce...', 'loading');

                const response = await fetch(`${backendUrl}/api/customers/search?q=${encodeURIComponent(searchTerm)}&session=${sessionToken}`);
                
                if (!response.ok) {
                    if (response.status === 401) {
                        console.log('Session expired, attempting to re-authenticate...');
                        handleSessionExpired();
                        return;
                    }
                    
                    const errorData = await response.json().catch(() => ({ error: 'Unknown error' }));
                    throw new Error(errorData.error || `Search failed: ${response.status}`);
                }

                const data = await response.json();
                displaySearchResults(data.customers);
                
            } catch (error) {
                console.error('Search error:', error);
                
                // Handle network errors or fetch failures
                if (error.message === 'Failed to fetch' || error.name === 'TypeError') {
                    showMessage('searchResults', 'Connection lost. Please check your internet connection and try again.', 'error');
                } else {
                    showMessage('searchResults', `Search failed: ${error.message}`, 'error');
                }
            }
        }

        // Handle session expiration
        function handleSessionExpired() {
            sessionToken = null;
            localStorage.removeItem('salesforce_session_token');
            localStorage.removeItem('salesforce_session_token_temp');
            
            // Reset UI to authentication state
            document.getElementById('statusSection').style.display = 'block';
            document.getElementById('searchSection').style.display = 'none';
            document.getElementById('selectedCustomerSection').style.display = 'none';
            document.getElementById('proceedBtn').style.display = 'none';
            
            // Show manual reconnection option instead of auto-retry
            showMessage('authResult', 
                `<div style="text-align: center;">
                    <p><strong>Session expired.</strong></p>
                    <p>Choose an option to reconnect:</p>
                    <div style="margin: 15px 0;">
                        <button onclick="manualReconnect()" style="background-color: #007bff; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; margin: 5px;">
                            Reconnect to Salesforce
                        </button>
                        <br>
                        <button onclick="restartWorkflow()" style="background-color: #28a745; color: white; padding: 8px 16px; border: none; border-radius: 5px; cursor: pointer; margin: 5px;">
                            Start Fresh
                        </button>
                    </div>
                    <p style="font-size: 12px; color: #666;">
                        If you see a browser warning, click "Advanced" ‚Üí "Proceed to site (unsafe)"<br>
                        Or use "Start Fresh" to restart the entire process.
                    </p>
                </div>`, 
                'error'
            );
        }

        // Manual reconnection function
        function manualReconnect() {
            showMessage('authResult', 'Connecting to Salesforce...', 'loading');
            autoAuthenticate();
        }

        // Restart the entire workflow
        function restartWorkflow() {
            closeNewRequestLightbox();
            // Clear any stored session data
            localStorage.removeItem('salesforce_session_token');
            localStorage.removeItem('salesforce_session_token_temp');
            sessionToken = null;
            selectedCustomer = null;
            // Restart the process
            setTimeout(() => {
                openNewRequestLightbox();
            }, 500);
        }

        // Display search results
        function displaySearchResults(customers) {
            const resultsDiv = document.getElementById('searchResults');
            
            if (!customers || customers.length === 0) {
                resultsDiv.innerHTML = '<div style="color: #dc3545; padding: 10px; border-radius: 4px; background-color: #f8d7da;">No customers found matching your search term.</div>';
                return;
            }

            let html = `<h4>Found ${customers.length} customer(s):</h4>`;
            
            customers.forEach(customer => {
                html += `
                    <div style="border: 1px solid #ddd; padding: 15px; margin-bottom: 10px; border-radius: 5px; background-color: white; cursor: pointer;" onclick="selectCustomer('${customer.id}')">
                        <h4 style="margin: 0 0 10px 0; color: #007bff;">${customer.name}</h4>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                            <div><strong>Type:</strong> ${customer.type || 'Not specified'}</div>
                            <div><strong>Phone:</strong> ${customer.phone || 'Not provided'}</div>
                            <div><strong>Website:</strong> ${customer.website || 'Not provided'}</div>
                            <div><strong>Location:</strong> ${customer.city || ''}, ${customer.state || ''}</div>
                        </div>
                        <button style="background-color: #007bff; color: white; padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; margin-top: 10px;" onclick="event.stopPropagation(); selectCustomer('${customer.id}')">
                            Select This Customer
                        </button>
                    </div>
                `;
            });
            
            resultsDiv.innerHTML = html;
        }

        // Select a customer
        async function selectCustomer(customerId) {
            try {
                showMessage('selectedCustomerDetails', 'Loading customer details...', 'loading');
                
                const response = await fetch(`${backendUrl}/api/customers/${customerId}?session=${sessionToken}`);
                
                if (!response.ok) {
                    throw new Error(`Failed to get customer details: ${response.status}`);
                }

                const data = await response.json();
                selectedCustomer = data.customer;
                
                displaySelectedCustomer(selectedCustomer);
                document.getElementById('selectedCustomerSection').style.display = 'block';
                document.getElementById('proceedBtn').style.display = 'inline-block';
                
            } catch (error) {
                console.error('Customer selection error:', error);
                showMessage('selectedCustomerDetails', `Failed to load customer: ${error.message}`, 'error');
            }
        }

        // Display selected customer
        function displaySelectedCustomer(customer) {
            const detailsDiv = document.getElementById('selectedCustomerDetails');
            
            const html = `
                <div style="background-color: white; padding: 15px; border-radius: 5px;">
                    <h4 style="margin: 0 0 15px 0; color: #007bff;">${customer.name}</h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <div><strong>Type:</strong> ${customer.type || 'Not specified'}</div>
                        <div><strong>Industry:</strong> ${customer.industry || 'Not specified'}</div>
                        <div><strong>Phone:</strong> ${customer.phone || 'Not provided'}</div>
                        <div><strong>Email:</strong> ${customer.email || 'Not provided'}</div>
                        <div><strong>Website:</strong> ${customer.website || 'Not provided'}</div>
                        <div><strong>Employees:</strong> ${customer.employeeCount || 'Not specified'}</div>
                        <div><strong>City:</strong> ${customer.city || 'Not provided'}</div>
                        <div><strong>State:</strong> ${customer.state || 'Not provided'}</div>
                    </div>
                    <p style="margin-top: 10px;"><strong>Salesforce ID:</strong> ${customer.id}</p>
                </div>
            `;
            
            detailsDiv.innerHTML = html;
        }

        // Proceed to form with selected customer
        function proceedToForm() {
            if (!selectedCustomer) return;
            
            // Store selected customer data
            localStorage.setItem('selectedSalesforceCustomer', JSON.stringify({
                id: selectedCustomer.id,
                name: selectedCustomer.name,
                type: selectedCustomer.type,
                phone: selectedCustomer.phone,
                email: selectedCustomer.email,
                website: selectedCustomer.website,
                city: selectedCustomer.city,
                state: selectedCustomer.state,
                country: selectedCustomer.country,
                industry: selectedCustomer.industry,
                selectedAt: new Date().toISOString(),
                source: 'admin_console' // Track that this came from admin
            }));
            
            // Navigate to main form
            window.location.href = 'index.html';
        }

        // Utility function to show messages
        function showMessage(elementId, message, type) {
            const element = document.getElementById(elementId);
            let className = '';
            switch(type) {
                case 'error': className = 'color: #dc3545; background-color: #f8d7da; padding: 10px; border-radius: 4px;'; break;
                case 'success': className = 'color: #155724; background-color: #d4edda; padding: 10px; border-radius: 4px;'; break;
                case 'loading': className = 'color: #007bff; font-style: italic;'; break;
            }
            element.innerHTML = `<div style="${className}">${message}</div>`;
        }

        // Initialize on page load
        init();
    </script>
</body>
</html>